#!/usr/bin/env ruby
# frozen_string_literal: true
require 'bundler/setup'

require 'optparse'
class ArgsParser
  def self.parse!(args)
    options = {
      format: 'excel'
    }
    opt_parser = OptionParser.new do |opts|
      opts.banner = "Usage: dbtodoc [options]"

      opts.on('-f', '--format FORMAT', "指定输出格式，默认值：excel，可选值：ruby, sql, csv, excel") do |o|
        options[:format] = o
      end

      opts.on('-h', '--help', "显示帮助\n例：dbtodoc -f csv /rails/root/path") do
        puts opts
        exit
      end
    end
    # 解析命令行参数
    opt_parser.parse!(args)
    options
  end
end

# 解析命令行参数
options = ArgsParser.parse!(ARGV)
# 获取目标目录
path = ARGV.first || '.'
# 确保目录存在
unless File.exist?(path)
  puts "#{path}: 文件或目录不存在"
  exit 1
end
options[:path] = File.expand_path(path, Dir.pwd)
Dir.chdir(options[:path]) if path != '.' # 切换到目标目录
#获取__FILE__的真实路径，解决符号链接问题
lib_file = File.expand_path('../lib/dbtodoc.rb', File.dirname(File.realpath(__FILE__)))
puts "lib_file: #{lib_file}"
if File.exist?(lib_file)
  require_relative lib_file
else
  require 'dbtodoc'
end
Dbtodoc.start(options)